<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bochat Pro | Ù…Ù†ØµØ© Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</title>
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Ù…ÙƒØªØ¨Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙØ§Øª Excel -->
    <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=BkNWrm1BJyhWCOhJ6q8IX3Q9Ld4cp69aRHql9cIRgPHVM6rUb82gb35X57BQSL57sBsHL5tfolNk6ulxoaQoEdbW4csdAj2AfLE-2d_Q-OYUeAAl_9rWCtmGlTsFBx-TKE6NgmJEDyfgH3XzdEmIlPAo801OyeNMs47DE8LdjNzvHT_bOdpCaRrFYoEXkv8lO-e3v8udBXxYPBekPP9QuSo8rKUEdhsYEUJUxD_QVSODkBJ5C4G1F_ZbPDJR_OvjaIJLLXX80HxK1uP8eX-P3HRzV6jjEu2DNYQMctf1PlhA1N3bzEys25HRxR7GRYVvC7BxIvtoUBubI8TBWe_Q9WineAzYrq6IuXXBSJXhYbnrnEVguSMUhGRn1VmPL8PxGaJxWUgoaF_KwHDSFAbyJlqy0NS3iNeGYriKnL1S8jCL17WsHAt3v9Uq46j26ERgpYCSabRy5RGAtFZ1KBgOLrTXPhk4y5mx3BNxPm7tsf53pFsYUwWSqohRdkDcCCY0l5ovHMN-wMig4Ieez_t5Xnt9_lS6Q8ruRqMHLs1A3Tbl87rW1f-oOugHp1S3H0WFxiZt2Xqq24c-E8BMfZYvrFau4sbrdf-goL-OheHpSqqFXB9XiGTPsjKZsvBuMFT-HEoo5d4GA0NZJWkw7fytQFNHH71Pi3TxbH5NTCZR1M08YtRFoUcID2pcV_S0qzcjymLFNSnXcIMow-34v0_kt34LiJneKE7pGDGYESzFz5iSc_3Zru7aSFaibsGuOmGTMKPdTtamg7tTrk7-iATW6XnzvJR4g70phVT59yWz36WJ5c624GqasILjqdIq3Fho" charset="UTF-8"></script><link rel="stylesheet" crossorigin="anonymous" href="https://gc.kis.v2.scr.kaspersky-labs.com/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly9zcnYxODAzLWZpbGVzLmhzdGdyLmlvL2M3MDFjOTJkZmQ3YTg3ODUvYXBpL3Jhdy9wdWJsaWNfaHRtbC9haS9jaGF0Ym94Lmh0bWw_YXV0aD1leUpoYkdjaU9pSklVekkxTmlJc0luUjVjQ0k2SWtwWFZDSjkuZXlKMWMyVnlJanA3SW1sa0lqb3hMQ0pzYjJOaGJHVWlPaUpoY2w5QlVpSXNJblpwWlhkTmIyUmxJam9pYkdsemRDSXNJbk5wYm1kc1pVTnNhV05ySWpwbVlXeHpaU3dpY0dWeWJTSTZleUpoWkcxcGJpSTZabUZzYzJVc0ltVjRaV04xZEdVaU9tWmhiSE5sTENKamNtVmhkR1VpT25SeWRXVXNJbkpsYm1GdFpTSTZkSEoxWlN3aWJXOWthV1o1SWpwMGNuVmxMQ0prWld4bGRHVWlPblJ5ZFdVc0luTm9ZWEpsSWpwbVlXeHpaU3dpWkc5M2JteHZZV1FpT25SeWRXVjlMQ0pqYjIxdFlXNWtjeUk2VzEwc0lteHZZMnRRWVhOemQyOXlaQ0k2ZEhKMVpTd2lhR2xrWlVSdmRHWnBiR1Z6SWpwbVlXeHpaU3dpWkdGMFpVWnZjbTFoZENJNlptRnNjMlY5TENKcGMzTWlPaUpHYVd4bElFSnliM2R6WlhJaUxDSmxlSEFpT2pFM05qUTROREEzTnpjc0ltbGhkQ0k2TVRjMk5EZ3pNelUzTjMwLkFsVXA2Q0wtNXNva1Jpd01iZU44TVM4YTd2LTFGRXBmX0FuX0xtTE9jTUUm"/><script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #4f46e5;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; outline: none; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); min-height: 100vh; display: flex; overflow-x: hidden; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar {
            width: 260px; background: rgba(30, 41, 59, 0.9); 
            backdrop-filter: blur(10px); border-left: 1px solid #334155;
            padding: 25px; display: flex; flex-direction: column;
            position: fixed; right: 0; height: 100%; z-index: 100;
        }

        .brand {
            font-size: 1.6rem; font-weight: 800; margin-bottom: 40px;
            background: linear-gradient(to right, #6366f1, #a855f7);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            display: flex; align-items: center; gap: 10px;
        }

        .nav-item {
            padding: 12px 15px; border-radius: 12px; margin-bottom: 8px; cursor: pointer;
            color: var(--text-muted); transition: 0.3s; font-weight: 500; display: flex; align-items: center; gap: 12px;
        }
        .nav-item.active, .nav-item:hover { background: #334155; color: white; border-right: 3px solid var(--primary); }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-content { margin-right: 260px; width: calc(100% - 260px); padding: 30px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .btn-main {
            background: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-main:hover { background: var(--secondary); transform: translateY(-2px); }

        /* Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        
        .card {
            background: var(--bg-card); border-radius: 16px; padding: 20px;
            border: 1px solid #334155; position: relative; transition: 0.3s;
            display: flex; flex-direction: column;
        }
        .card:hover { border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .card.active { border-color: var(--success); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .bot-icon {
            width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;
            background: rgba(255,255,255,0.05); color: var(--text-muted);
        }
        
        .tags { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 5px; background: #0f172a; color: #94a3b8; }
        .tag.excel { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }

        .controls { display: flex; gap: 10px; margin-top: auto; padding-top: 15px; border-top: 1px solid #334155; }
        .btn-icon {
            flex: 1; padding: 8px; border-radius: 8px; border: none; cursor: pointer; background: #0f172a; color: var(--text-muted); transition: 0.2s;
            font-size: 0.9rem; display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        .btn-icon:hover { background: #334155; color: white; }
        .btn-icon.train:hover { color: var(--primary); }
        .btn-icon.delete:hover { color: var(--danger); }

        /* Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ´ØºÙŠÙ„ */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 200;
            display: none; justify-content: center; align-items: center;
        }
        .modal {
            background: var(--bg-card); width: 600px; padding: 30px; border-radius: 20px;
            border: 1px solid #334155; animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto;
        }
        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; }
        .form-input {
            width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155;
            border-radius: 10px; color: white; font-size: 0.95rem;
        }
        .form-input:focus { border-color: var(--primary); }
        textarea.form-input { min-height: 120px; resize: vertical; line-height: 1.6; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù */
        .upload-box {
            border: 2px dashed #334155; border-radius: 12px; padding: 25px; text-align: center;
            cursor: pointer; transition: 0.2s; background: rgba(33, 115, 70, 0.05);
        }
        .upload-box:hover { border-color: var(--success); background: rgba(33, 115, 70, 0.1); }
        .upload-box i { font-size: 2.5rem; color: var(--success); margin-bottom: 15px; }

        /* Ø¥Ø´Ø¹Ø§Ø± Gmail */
        .gmail-toast {
            position: fixed; bottom: 20px; left: 20px; background: white; color: #333;
            padding: 15px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            display: none; width: 320px; z-index: 999; border-left: 6px solid #EA4335;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="brand"><i class="fa-solid fa-brain"></i> Bochat Pro</div>
        <div class="nav-item active"><i class="fa-solid fa-robot"></i> Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
        <div class="nav-item"><i class="fa-solid fa-database"></i> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</div>
        <div class="nav-item"><i class="fa-solid fa-sliders"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div>
                <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                <p style="color:var(--text-muted)">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙˆØªØ§Øª ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø°ÙƒÙŠ ÙˆØ±Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
            </div>
            <button class="btn-main" onclick="openModal('addModal')"><i class="fa-solid fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØª Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <div class="grid" id="botsGrid"></div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØª -->
    <div id="addModal" class="modal-overlay">
        <div class="modal">
            <h3 style="margin-bottom:20px;">Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØª Ø¬Ø¯ÙŠØ¯</h3>
            
            <div class="form-group">
                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙˆØª</label>
                <select id="botType" class="form-input" onchange="renderAddFields()">
                    <option value="telegram">ğŸ”µ Ø¨ÙˆØª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (Ù…Ø­Ø§Ø¯Ø«Ø© + Ø¨ÙŠØ§Ù†Ø§Øª)</option>
                    <option value="gmail">ğŸ”´ Ø¨ÙˆØª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Gmail + Telegram)</option>
                    <option value="whatsapp">ğŸŸ¢ ÙˆØ§ØªØ³Ø§Ø¨ (Cloud API)</option>
                    <option value="userbot">ğŸŸ£ Ø±Ù‚Ù… Ø´Ø®ØµÙŠ (Userbot)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª (Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø©)</label>
                <input type="text" id="botName" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙˆØª Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡">
            </div>

            <div id="addDynamicFields"></div>

            <button class="btn-main" style="width:100%; justify-content:center; margin-top:20px;" onclick="saveNewBot()">Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡</button>
            <button onclick="closeModal('addModal')" style="width:100%; background:transparent; border:none; color:#94a3b8; margin-top:10px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¨ÙˆØª Ùˆ Excel -->
    <div id="trainModal" class="modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3><i class="fa-solid fa-graduation-cap"></i> ØªØ¹Ù„ÙŠÙ… ÙˆØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¨ÙˆØª</h3>
                <button onclick="closeModal('trainModal')" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <input type="hidden" id="trainBotId">

            <div class="form-group">
                <label class="form-label">1. ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© (System Prompt)</label>
                <textarea id="systemPrompt" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø£Ù†Øª Ù…ÙˆØ¸Ù Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ø´Ø±ÙƒØ© Ø¹Ù‚Ø§Ø±Ø§Øª. Ø£Ø³Ù„ÙˆØ¨Ùƒ Ù…Ø­ØªØ±Ù…. Ù‡Ø¯ÙÙƒ Ø¥Ù‚Ù†Ø§Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø´Ø±Ø§Ø¡..."></textarea>
                <p style="font-size:0.8rem; color:#6366f1; margin-top:5px;">* Ø³ÙŠØªÙ‚Ù…Øµ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø®ØµÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¯.</p>
            </div>

            <div class="form-group">
                <label class="form-label">2. ØªØºØ°ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Excel / CSV)</label>
                <div class="upload-box" onclick="document.getElementById('excelInput').click()">
                    <i class="fa-solid fa-file-excel"></i>
                    <p>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ Ù…Ù„Ù Excel</p>
                    <span style="font-size:0.8rem; color:#94a3b8">(.xlsx, .csv) Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø¨ÙˆØª Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù†Ù‡</span>
                </div>
                <input type="file" id="excelInput" hidden accept=".xlsx, .xls, .csv" onchange="handleFileUpload(this)">
                
                <div id="fileStatus" style="margin-top:10px; font-size:0.9rem; color:#4ade80; display:none;">
                    <i class="fa-solid fa-check-circle"></i> ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© (Ù†ØµÙŠØ©)</label>
                <textarea id="extractedData" class="form-input" readonly style="opacity:0.6; height:100px; font-family:monospace;" placeholder="Ø³ØªØ¸Ù‡Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ Ù‡Ù†Ø§..."></textarea>
            </div>

            <button class="btn-main" style="width:100%; justify-content:center" onclick="saveTraining()">Ø­ÙØ¸ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</button>
        </div>
    </div>

    <!-- Ø¥Ø´Ø¹Ø§Ø± Gmail Ø§Ù„Ù…Ø­Ø§ÙƒÙ‰ -->
    <div id="gmailToast" class="gmail-toast">
        <div style="font-weight:bold; margin-bottom:5px; display:flex; align-items:center; gap:8px;">
            <i class="fa-brands fa-google" style="color:#EA4335"></i> Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯ Ø¹Ø¨Ø± Gmail
        </div>
        <div style="font-size:0.85rem; line-height:1.5;">
            <b>Ø§Ù„Ù…Ø±Ø³Ù„:</b> aliatb27@gmail.com<br>
            <b>Ø§Ù„Ù…Ø³ØªÙ„Ù…:</b> <span id="targetEmailDisplay">...</span><br>
            <div style="margin-top:5px; padding-top:5px; border-top:1px solid #eee;">
                ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.
            </div>
        </div>
    </div>

    <!-- ================= LOGIC ================= -->
    <script>
        // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø­Ø§Ù„Ø© ---
        let bots = JSON.parse(localStorage.getItem('bochat_pro_db') || '[]');
        const activeWorkers = {};

        // --- Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ---
        window.addEventListener('DOMContentLoaded', () => {
            renderAddFields();
            renderGrid();
        });

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function renderAddFields() {
            const type = document.getElementById('botType').value;
            const container = document.getElementById('addDynamicFields');
            container.innerHTML = '';

            let html = '';
            if (type === 'telegram') {
                html = `<div class="form-group"><label class="form-label">Token (Ù…Ù† BotFather)</label><input type="text" id="f_token" class="form-input" placeholder="123456:ABC-DEF..."></div>`;
            } else if (type === 'gmail') {
                html = `
                    <div class="form-group"><label class="form-label">Telegram Token (Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª)</label><input type="text" id="f_token" class="form-input"></div>
                    <div class="form-group"><label class="form-label">Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª)</label><input type="email" id="f_email" class="form-input" placeholder="example@gmail.com"></div>
                `;
            } else if (type === 'whatsapp') {
                html = `<div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Cloud API)</label><input type="text" id="f_phone" class="form-input"></div>`;
            } else if (type === 'userbot') {
                html = `<div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø´Ø®ØµÙŠ</label><input type="text" id="f_phone" class="form-input"></div>`;
            }
            container.innerHTML = html;
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙˆØªØ§Øª (Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù) ---
        function saveNewBot() {
            const type = document.getElementById('botType').value;
            const name = document.getElementById('botName').value;
            if(!name) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");

            const bot = {
                id: Date.now(),
                name: name,
                type: type,
                active: false,
                config: {},
                training: {
                    systemPrompt: "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙˆÙ…ÙÙŠØ¯.",
                    excelData: "" 
                }
            };

            if(type === 'telegram' || type === 'gmail') {
                bot.config.token = document.getElementById('f_token').value;
                if(type === 'gmail') bot.config.targetEmail = document.getElementById('f_email').value;
            } else {
                bot.config.phone = document.getElementById('f_phone').value;
            }

            bots.push(bot);
            saveToLocal();
            closeModal('addModal');
            renderGrid();
        }

        function deleteBot(id) {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¨ÙˆØªØŸ')) {
                toggleBot(id, false); 
                bots = bots.filter(b => b.id !== id);
                saveToLocal();
                renderGrid();
            }
        }

        // --- Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ùˆ Excel ---
        function openTrainModal(id) {
            const bot = bots.find(b => b.id === id);
            document.getElementById('trainBotId').value = id;
            document.getElementById('systemPrompt').value = bot.training.systemPrompt || "";
            document.getElementById('extractedData').value = bot.training.excelData || "";
            document.getElementById('fileStatus').style.display = 'none';
            openModal('trainModal');
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const csvText = XLSX.utils.sheet_to_csv(worksheet);
                
                document.getElementById('extractedData').value = csvText;
                document.getElementById('fileStatus').style.display = 'block';
            };
            reader.readAsArrayBuffer(file);
        }

        function saveTraining() {
            const id = parseInt(document.getElementById('trainBotId').value);
            const bot = bots.find(b => b.id === id);
            
            bot.training.systemPrompt = document.getElementById('systemPrompt').value;
            bot.training.excelData = document.getElementById('extractedData').value;
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            if(bot.active) {
                toggleBot(id, false);
                setTimeout(() => toggleBot(id, true), 300);
            }

            saveToLocal();
            closeModal('trainModal');
            renderGrid();
        }

        // --- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Worker Engine) ---
        function toggleBot(id, forceState = null) {
            const bot = bots.find(b => b.id === id);
            const newState = forceState !== null ? forceState : !bot.active;
            
            bot.active = newState;
            
            if(bot.active) {
                if(bot.type === 'telegram' || bot.type === 'gmail') {
                    startAIWorker(bot);
                } else {
                    alert('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© (Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ ÙŠØªØ·Ù„Ø¨ Ø±Ø¨Ø·Ø§Ù‹ Ù…ØªÙ‚Ø¯Ù…Ø§Ù‹ Ø¨Ø³ÙŠØ±ÙØ±).');
                }
            } else {
                stopWorker(bot.id);
            }
            
            saveToLocal();
            renderGrid();
        }

        function startAIWorker(bot) {
            if(activeWorkers[bot.id]) return;

            // Ø¯Ù…Ø¬ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„
            let fullContext = bot.training.systemPrompt;
            if(bot.training.excelData) {
                fullContext += `\n\n[Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© - Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©]:\n${bot.training.excelData}`;
            }

            // ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„ (Worker Code) ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
            const workerCode = `
                let offset = 0;
                const API_URL = "https://text.pollinations.ai/";

                onmessage = async (e) => {
                    const { token, type, targetEmail, context } = e.data;
                    
                    const poll = async () => {
                        try {
                            // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
                            const res = await fetch(\`https://api.telegram.org/bot\${token}/getUpdates?offset=\${offset+1}&timeout=5\`);
                            const data = await res.json();
                            
                            if(data.ok) {
                                for(const u of data.result) {
                                    offset = u.update_id;
                                    if(u.message && u.message.text) {
                                        const userText = u.message.text;
                                        const chatId = u.message.chat.id;
                                        
                                        // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Gmail)
                                        if(type === 'gmail' && (userText.includes('Ø­Ø¬Ø²') || userText.includes('booking'))) {
                                            postMessage({ 
                                                action: 'booking', 
                                                chatId: chatId, 
                                                targetEmail: targetEmail 
                                            });
                                            // Ø±Ø¯ ØªØ£ÙƒÙŠØ¯ Ø³Ø±ÙŠØ¹
                                            await fetch(\`https://api.telegram.org/bot\${token}/sendMessage\`, {
                                                method: 'POST',
                                                headers: {'Content-Type': 'application/json'},
                                                body: JSON.stringify({ chat_id: chatId, text: "ğŸ“§ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ aliatb27@gmail.com." })
                                            });
                                            continue; 
                                        }

                                        // 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (AI)
                                        try {
                                            const aiRes = await fetch(API_URL, {
                                                method: 'POST',
                                                headers: {'Content-Type': 'application/json'},
                                                body: JSON.stringify({
                                                    messages: [
                                                        {role: 'system', content: context},
                                                        {role: 'user', content: userText}
                                                    ],
                                                    model: 'openai',
                                                    seed: Math.floor(Math.random() * 1000)
                                                })
                                            });
                                            const aiText = await aiRes.text();
                                            
                                            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
                                            await fetch(\`https://api.telegram.org/bot\${token}/sendMessage\`, {
                                                method: 'POST',
                                                headers: {'Content-Type': 'application/json'},
                                                body: JSON.stringify({ chat_id: chatId, text: aiText })
                                            });

                                        } catch(err) { console.error(err); }
                                    }
                                }
                            }
                        } catch(err) {}
                        setTimeout(poll, 1000);
                    };
                    poll();
                };
            `;

            const blob = new Blob([workerCode], {type: 'application/javascript'});
            const worker = new Worker(URL.createObjectURL(blob));
            
            worker.postMessage({ 
                token: bot.config.token, 
                type: bot.type, 
                targetEmail: bot.config.targetEmail,
                context: fullContext
            });

            worker.onmessage = (e) => {
                if(e.data.action === 'booking') {
                    showGmailToast(e.data.targetEmail);
                }
            };

            activeWorkers[bot.id] = worker;
        }

        function stopWorker(id) {
            if(activeWorkers[id]) {
                activeWorkers[id].terminate();
                delete activeWorkers[id];
            }
        }

        // --- Ø§Ù„Ø¹Ø±Ø¶ (Rendering) ---
        function renderGrid() {
            const grid = document.getElementById('botsGrid');
            grid.innerHTML = '';

            bots.forEach(bot => {
                let icon = '', typeLabel = '';
                if(bot.type==='telegram') { icon = '<i class="fa-brands fa-telegram" style="color:#229ED9"></i>'; typeLabel='ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…'; }
                else if(bot.type==='gmail') { icon = '<i class="fa-solid fa-envelope" style="color:#EA4335"></i>'; typeLabel='Ø­Ø¬ÙˆØ²Ø§Øª'; }
                else if(bot.type==='whatsapp') { icon = '<i class="fa-brands fa-whatsapp" style="color:#25D366"></i>'; typeLabel='ÙˆØ§ØªØ³Ø§Ø¨'; }
                else { icon = '<i class="fa-solid fa-user-shield" style="color:#A855F7"></i>'; typeLabel='Ø´Ø®ØµÙŠ'; }

                const hasExcel = bot.training.excelData && bot.training.excelData.length > 5;
                const isTrained = bot.training.systemPrompt && bot.training.systemPrompt.length > 10;

                const card = document.createElement('div');
                card.className = `card ${bot.active ? 'active' : ''}`;
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="bot-icon">${icon}</div>
                        <label class="switch">
                            <input type="checkbox" ${bot.active ? 'checked' : ''} onchange="toggleBot(${bot.id})">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <h3 style="margin-bottom:5px;">${bot.name}</h3>
                    <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:15px;">${typeLabel}</p>
                    
                    <div class="tags">
                        ${hasExcel ? '<span class="tag excel"><i class="fa-solid fa-table"></i> Ù…Ø±ØªØ¨Ø· Ø¨Ù€ Excel</span>' : ''}
                        ${isTrained ? '<span class="tag"><i class="fa-solid fa-brain"></i> Ù…Ø¯Ø±Ø¨</span>' : '<span class="tag">ØºÙŠØ± Ù…Ø¯Ø±Ø¨</span>'}
                    </div>

                    <div class="controls">
                        <button class="btn-icon train" onclick="openTrainModal(${bot.id})" title="ØªØ¯Ø±ÙŠØ¨">
                            <i class="fa-solid fa-graduation-cap"></i> ØªØ¯Ø±ÙŠØ¨
                        </button>
                        <button class="btn-icon delete" onclick="deleteBot(${bot.id})" title="Ø­Ø°Ù">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function showGmailToast(email) {
            const t = document.getElementById('gmailToast');
            document.getElementById('targetEmailDisplay').innerText = email;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 5000);
        }

        function saveToLocal() { localStorage.setItem('bochat_pro_db', JSON.stringify(bots)); }
    </script>
</body>
</html>