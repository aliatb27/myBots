<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bochat Pro | Ù…Ù†ØµØ© Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</title>
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Ù…ÙƒØªØ¨Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙØ§Øª Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-rgb: 99, 102, 241; /* Added for rgba usage in disclaimer */
            --secondary: #4f46e5;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; outline: none; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); min-height: 100vh; display: flex; overflow-x: hidden; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .sidebar {
            width: 260px; background: rgba(30, 41, 59, 0.9); 
            backdrop-filter: blur(10px); border-left: 1px solid #334155;
            padding: 25px; display: flex; flex-direction: column;
            position: fixed; right: 0; height: 100%; z-index: 100;
        }

        .brand {
            font-size: 1.6rem; font-weight: 800; margin-bottom: 40px;
            background: linear-gradient(to right, #6366f1, #a855f7);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            display: flex; align-items: center; gap: 10px;
        }

        .nav-item {
            padding: 12px 15px; border-radius: 12px; margin-bottom: 8px; cursor: pointer;
            color: var(--text-muted); transition: 0.3s; font-weight: 500; display: flex; align-items: center; gap: 12px;
        }
        .nav-item.active, .nav-item:hover { background: #334155; color: white; border-right: 3px solid var(--primary); }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-content { margin-right: 260px; width: calc(100% - 260px); padding: 30px; }

        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; }
        .btn-main {
            background: var(--primary); color: white; border: none; padding: 10px 20px;
            border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-main:hover { background: var(--secondary); transform: translateY(-2px); }

        /* Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        
        .card {
            background: var(--bg-card); border-radius: 16px; padding: 20px;
            border: 1px solid #334155; position: relative; transition: 0.3s;
            display: flex; flex-direction: column;
        }
        .card:hover { border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .card.active { border-color: var(--success); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .bot-icon {
            width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;
            background: rgba(255,255,255,0.05); color: var(--text-muted);
        }
        
        .tags { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 5px; background: #0f172a; color: #94a3b8; }
        .tag.excel { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }

        .controls { display: flex; gap: 10px; margin-top: auto; padding-top: 15px; border-top: 1px solid #334155; }
        .btn-icon {
            flex: 1; padding: 8px; border-radius: 8px; border: none; cursor: pointer; background: #0f172a; color: var(--text-muted); transition: 0.2s;
            font-size: 0.9rem; display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        .btn-icon:hover { background: #334155; color: white; }
        .btn-icon.train:hover { color: var(--primary); }
        .btn-icon.delete:hover { color: var(--danger); }

        /* Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ´ØºÙŠÙ„ */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 200;
            display: none; justify-content: center; align-items: center;
        }
        .modal {
            background: var(--bg-card); width: 600px; padding: 30px; border-radius: 20px;
            border: 1px solid #334155; animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto;
        }
        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: var(--text-muted); font-size: 0.9rem; }
        .form-input {
            width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155;
            border-radius: 10px; color: white; font-size: 0.95rem;
        }
        .form-input:focus { border-color: var(--primary); }
        textarea.form-input { min-height: 120px; resize: vertical; line-height: 1.6; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù */
        .upload-box {
            border: 2px dashed #334155; border-radius: 12px; padding: 25px; text-align: center;
            cursor: pointer; transition: 0.2s; background: rgba(33, 115, 70, 0.05);
        }
        .upload-box:hover { border-color: var(--success); background: rgba(33, 115, 70, 0.1); }
        .upload-box i { font-size: 2.5rem; color: var(--success); margin-bottom: 15px; }

        /* Ø¥Ø´Ø¹Ø§Ø± Gmail */
        .gmail-toast {
            position: fixed; bottom: 20px; left: 20px; background: white; color: #333;
            padding: 15px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            display: none; width: 320px; z-index: 999; border-left: 6px solid #EA4335;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="brand"><i class="fa-solid fa-brain"></i> Bochat Pro</div>
        <div class="nav-item active"><i class="fa-solid fa-robot"></i> Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©</div>
        <div class="nav-item"><i class="fa-solid fa-database"></i> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</div>
        <div class="nav-item"><i class="fa-solid fa-sliders"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div>
                <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                <p style="color:var(--text-muted)">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙˆØªØ§Øª ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø°ÙƒÙŠ ÙˆØ±Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                <!-- Disclaimer for client-side execution -->
                <div style="background: rgba(var(--primary-rgb), 0.1); border-right: 4px solid var(--primary); padding: 10px 15px; border-radius: 8px; margin-top: 15px; font-size: 0.85rem; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                    <i class="fa-solid fa-circle-info" style="color:var(--primary); font-size: 1.1rem; flex-shrink: 0;"></i>
                    <p>
                        <span style="font-weight: 500;">Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø§Ù…Ø©:</span> ØªØ¹Ù…Ù„ Ø§Ù„Ø¨ÙˆØªØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø·Ø§Ù„Ù…Ø§ Ø§Ù„ØµÙØ­Ø© Ù…ÙØªÙˆØ­Ø© ÙÙŠ Ù…ØªØµÙØ­Ùƒ. Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¨ÙˆØªØ§Øª ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù… (24/7) Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­ØŒ Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ø³ØªØ¶Ø§ÙØ© Ø§Ù„Ø¨ÙˆØªØ§Øª Ø¹Ù„Ù‰ Ø®Ø§Ø¯Ù… (Server-side application).
                    </p>
                </div>
            </div>
            <button class="btn-main" onclick="openModal('addModal')"><i class="fa-solid fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙˆØª Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <div class="grid" id="botsGrid"></div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØª -->
    <div id="addModal" class="modal-overlay">
        <div class="modal">
            <h3 style="margin-bottom:20px;">Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØª Ø¬Ø¯ÙŠØ¯</h3>
            
            <div class="form-group">
                <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙˆØª</label>
                <select id="botType" class="form-input" onchange="renderAddFields()">
                    <option value="telegram">ğŸ”µ Ø¨ÙˆØª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (Ù…Ø­Ø§Ø¯Ø«Ø© + Ø¨ÙŠØ§Ù†Ø§Øª)</option>
                    <option value="gmail">ğŸ”´ Ø¨ÙˆØª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Gmail + Telegram)</option>
                    <option value="whatsapp">ğŸŸ¢ ÙˆØ§ØªØ³Ø§Ø¨ (Cloud API)</option>
                    <option value="userbot">ğŸŸ£ Ø±Ù‚Ù… Ø´Ø®ØµÙŠ (Userbot)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª (Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø©)</label>
                <input type="text" id="botName" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø¨ÙˆØª Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡">
            </div>

            <div id="addDynamicFields"></div>

            <button class="btn-main" style="width:100%; justify-content:center; margin-top:20px;" onclick="saveNewBot()">Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡</button>
            <button onclick="closeModal('addModal')" style="width:100%; background:transparent; border:none; color:#94a3b8; margin-top:10px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¨ÙˆØª Ùˆ Excel -->
    <div id="trainModal" class="modal-overlay">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3><i class="fa-solid fa-graduation-cap"></i> ØªØ¹Ù„ÙŠÙ… ÙˆØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¨ÙˆØª</h3>
                <button onclick="closeModal('trainModal')" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <input type="hidden" id="trainBotId">

            <div class="form-group">
                <label class="form-label">1. ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© (System Prompt)</label>
                <textarea id="systemPrompt" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø£Ù†Øª Ù…ÙˆØ¸Ù Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ø´Ø±ÙƒØ© Ø¹Ù‚Ø§Ø±Ø§Øª. Ø£Ø³Ù„ÙˆØ¨Ùƒ Ù…Ø­ØªØ±Ù…. Ù‡Ø¯ÙÙƒ Ø¥Ù‚Ù†Ø§Ø¹ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø´Ø±Ø§Ø¡..."></textarea>
                <p style="font-size:0.8rem; color:#6366f1; margin-top:5px;">* Ø³ÙŠØªÙ‚Ù…Øµ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø®ØµÙŠØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¯.</p>
            </div>

            <div class="form-group">
                <label class="form-label">2. ØªØºØ°ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Excel / CSV)</label>
                <div class="upload-box" onclick="document.getElementById('excelInput').click()">
                    <i class="fa-solid fa-file-excel"></i>
                    <p>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ Ù…Ù„Ù Excel</p>
                    <span style="font-size:0.8rem; color:#94a3b8">(.xlsx, .xls, .csv) Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø¨ÙˆØª Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ù†Ù‡</span>
                </div>
                <input type="file" id="excelInput" hidden accept=".xlsx, .xls, .csv" onchange="handleFileUpload(this)">
                
                <div id="fileStatus" style="margin-top:10px; font-size:0.9rem; color:#4ade80; display:none;">
                    <i class="fa-solid fa-check-circle"></i> ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø© (Ù†ØµÙŠØ©)</label>
                <textarea id="extractedData" class="form-input" readonly style="opacity:0.6; height:100px; font-family:monospace;" placeholder="Ø³ØªØ¸Ù‡Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ Ù‡Ù†Ø§..."></textarea>
            </div>

            <button class="btn-main" style="width:100%; justify-content:center" onclick="saveTraining()">Ø­ÙØ¸ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</button>
        </div>
    </div>

    <!-- Ø¥Ø´Ø¹Ø§Ø± Gmail Ø§Ù„Ù…Ø­Ø§ÙƒÙ‰ -->
    <div id="gmailToast" class="gmail-toast">
        <div style="font-weight:bold; margin-bottom:5px; display:flex; align-items:center; gap:8px;">
            <i class="fa-brands fa-google" style="color:#EA4335"></i> Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯ Ø¹Ø¨Ø± Gmail
        </div>
        <div style="font-size:0.85rem; line-height:1.5;">
            <b>Ø§Ù„Ù…Ø±Ø³Ù„:</b> aliatb27@gmail.com<br>
            <b>Ø§Ù„Ù…Ø³ØªÙ„Ù…:</b> <span id="targetEmailDisplay">...</span><br>
            <div style="margin-top:5px; padding-top:5px; border-top:1px solid #eee;">
                ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.
            </div>
        </div>
    </div>

    <!-- ================= LOGIC ================= -->
    <script>
        // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø­Ø§Ù„Ø© ---
        // ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØªØ§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù…ØªØµÙØ­ (localStorage)
        let bots = JSON.parse(localStorage.getItem('bochat_pro_db') || '[]');
        // Ù‚Ø§Ù…ÙˆØ³ Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù€ Web Workers Ø§Ù„Ù†Ø´Ø·Ø© Ù„ÙƒÙ„ Ø¨ÙˆØª
        const activeWorkers = {};

        // --- Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ---
        window.addEventListener('DOMContentLoaded', () => {
            renderAddFields(); // Ø¹Ø±Ø¶ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            renderGrid();      // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        });

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Modals) ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØª Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ø­Ø¯Ø¯
        function renderAddFields() {
            const type = document.getElementById('botType').value;
            const container = document.getElementById('addDynamicFields');
            container.innerHTML = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©

            let html = '';
            if (type === 'telegram') {
                html = `<div class="form-group"><label class="form-label">Token (Ù…Ù† BotFather)</label><input type="text" id="f_token" class="form-input" placeholder="Ù…Ø«Ø§Ù„: 123456:ABC-DEF..."></div>`;
            } else if (type === 'gmail') {
                html = `
                    <div class="form-group"><label class="form-label">Telegram Token (Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª)</label><input type="text" id="f_token" class="form-input" placeholder="ØªÙˆÙƒÙ† Ø¨ÙˆØª Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…"></div>
                    <div class="form-group"><label class="form-label">Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª)</label><input type="email" id="f_email" class="form-input" placeholder="example@gmail.com"></div>
                `;
            } else if (type === 'whatsapp') {
                html = `<div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Cloud API)</label><input type="text" id="f_phone" class="form-input" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø±Ø¨ÙˆØ· Ø¨Ù€ Cloud API"></div>`;
            } else if (type === 'userbot') {
                html = `<div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø´Ø®ØµÙŠ</label><input type="text" id="f_phone" class="form-input" placeholder="Ù…Ø«Ø§Ù„: +9665xxxxxxxx"></div>`;
            }
            container.innerHTML = html;
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙˆØªØ§Øª (Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù) ---
        function saveNewBot() {
            const type = document.getElementById('botType').value;
            const name = document.getElementById('botName').value.trim();

            if (!name) {
                return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„Ø¨ÙˆØª.");
            }

            const bot = {
                id: Date.now(), // Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¨ÙˆØª
                name: name,
                type: type,
                active: false,
                config: {
                    lastUpdateOffset: 0 // Ù„Ø­ÙØ¸ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« ØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„
                },
                training: {
                    systemPrompt: "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙˆÙ…ÙÙŠØ¯.",
                    excelData: "" 
                }
            };

            // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙˆØª
            if (type === 'telegram' || type === 'gmail') {
                const token = document.getElementById('f_token').value.trim();
                if (!token) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¨ÙˆØª.");
                bot.config.token = token;
                if (type === 'gmail') {
                    const email = document.getElementById('f_email').value.trim();
                    if (!email) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.");
                    bot.config.targetEmail = email;
                }
            } else { // whatsapp, userbot
                const phone = document.getElementById('f_phone').value.trim();
                if (!phone) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.");
                bot.config.phone = phone;
            }

            bots.push(bot);
            saveToLocal(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
            closeModal('addModal');
            document.getElementById('botName').value = ''; // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù…
            renderGrid(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ© Ù„ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯
        }

        function deleteBot(id) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØªØŸ Ø³ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§ÙÙ‡ ÙˆØ¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡.')) {
                toggleBot(id, false); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø¨ÙˆØª Ø£ÙˆÙ„Ø§Ù‹
                bots = bots.filter(b => b.id !== id); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                saveToLocal(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                renderGrid(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ©
            }
        }

        // --- Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ùˆ Excel ---
        function openTrainModal(id) {
            const bot = bots.find(b => b.id === id);
            if (!bot) return; // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙˆØª

            document.getElementById('trainBotId').value = id;
            document.getElementById('systemPrompt').value = bot.training.systemPrompt || "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙˆÙ…ÙÙŠØ¯.";
            document.getElementById('extractedData').value = bot.training.excelData || "";
            document.getElementById('fileStatus').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            openModal('trainModal');
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const csvText = XLSX.utils.sheet_to_csv(worksheet);
                    
                    document.getElementById('extractedData').value = csvText;
                    document.getElementById('fileStatus').style.display = 'block';
                    input.value = ''; // Ù…Ø³Ø­ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø±ÙØ¹ Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
                } catch (error) {
                    console.error("Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Excel:", error);
                    alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ù…Ù„Ù ØµØ§Ù„Ø­.");
                    document.getElementById('fileStatus').style.display = 'none';
                }
            };
            reader.onerror = function(e) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù:", e);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.");
                document.getElementById('fileStatus').style.display = 'none';
            };
            reader.readAsArrayBuffer(file);
        }

        function saveTraining() {
            const id = parseInt(document.getElementById('trainBotId').value);
            const bot = bots.find(b => b.id === id);
            if (!bot) return;

            bot.training.systemPrompt = document.getElementById('systemPrompt').value.trim();
            bot.training.excelData = document.getElementById('extractedData').value.trim();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù†Ø´Ø·Ù‹Ø§
            if (bot.active) {
                toggleBot(id, false); // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª
                setTimeout(() => toggleBot(id, true), 300); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ ÙØªØ±Ø© ÙˆØ¬ÙŠØ²Ø©
            }

            saveToLocal(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            closeModal('trainModal');
            renderGrid(); // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ©
        }

        // --- ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Worker Engine) ---
        function toggleBot(id, forceState = null) {
            const bot = bots.find(b => b.id === id);
            if (!bot) return;

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù)
            const newState = forceState !== null ? forceState : !bot.active;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØªÙˆÙƒÙ† Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„
            if (newState && (bot.type === 'telegram' || bot.type === 'gmail') && !bot.config.token) {
                alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡ Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }
            if (newState && (bot.type === 'whatsapp' || bot.type === 'userbot') && !bot.config.phone) {
                alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙˆÙ„Ø§Ù‹.");
                return;
            }

            bot.active = newState;
            
            if (bot.active) {
                if (bot.type === 'telegram' || bot.type === 'gmail') {
                    startAIWorker(bot);
                } else {
                    // Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø®Ø±Ù‰ ØªØªØ·Ù„Ø¨ Ø±Ø¨Ø·Ù‹Ø§ Ø­Ù‚ÙŠÙ‚ÙŠÙ‹Ø§ Ø¨Ø³ÙŠØ±ÙØ±ØŒ Ù‡Ù†Ø§ Ù…Ø¬Ø±Ø¯ Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
                    console.warn(`Ø§Ù„Ø¨ÙˆØª Ù…Ù† Ù†ÙˆØ¹ ${bot.type} ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ØŒ Ù„ÙƒÙ† Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ Ø±Ø¨Ø·Ø§Ù‹ Ù…ØªÙ‚Ø¯Ù…Ø§Ù‹ Ø¨Ø³ÙŠØ±ÙØ±. Ù‡Ù†Ø§ Ù…Ø¬Ø±Ø¯ Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ø²Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„.`);
                }
            } else {
                stopWorker(bot.id);
            }
            
            saveToLocal(); // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„/Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
            renderGrid(); // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ©
        }

        function startAIWorker(bot) {
            if (activeWorkers[bot.id]) {
                console.log(`Worker for bot ${bot.id} is already running.`);
                return; // Ù„Ø§ ØªØ´ØºÙ„ Worker Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„
            }

            // Ø¯Ù…Ø¬ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ ÙƒÙ€ "Ø³ÙŠØ§Ù‚" Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
            let fullContext = bot.training.systemPrompt;
            if (bot.training.excelData) {
                fullContext += `\n\n[Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© - Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©]:\n${bot.training.excelData}`;
            }

            // ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø§Ù…Ù„ (Web Worker) Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
            const workerCode = `
                let offset = 0; // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ø§Ø­Ù‚Ø§Ù‹
                const API_URL = "https://text.pollinations.ai/"; // Ù†Ù‚Ø·Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ

                // Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø«Ø±ÙŠØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                onmessage = async (e) => {
                    const { token, type, targetEmail, context, initialOffset, botId } = e.data;
                    offset = initialOffset || 0; // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù€ offset Ø¨Ø¢Ø®Ø± Ù‚ÙŠÙ…Ø© Ù…Ø­ÙÙˆØ¸Ø©

                    console.log(\`[Worker ${botId}] Starting polling with offset: \${offset}\`);

                    const poll = async () => {
                        try {
                            // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… getUpdates
                            const res = await fetch(\`https://api.telegram.org/bot\${token}/getUpdates?offset=\${offset + 1}&timeout=30\`); // timeout Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª
                            if (!res.ok) {
                                throw new Error(\`Telegram API error: \${res.status} \${res.statusText}\`);
                            }
                            const data = await res.json();
                            
                            if (data.ok && data.result.length > 0) {
                                for (const u of data.result) {
                                    offset = u.update_id; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ offset Ù„Ø£Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« ØªÙ… Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡
                                    
                                    if (u.message && u.message.text) {
                                        const userText = u.message.text;
                                        const chatId = u.message.chat.id;
                                        console.log(\`[Worker ${botId}] Received message from \${chatId}: \${userText}\`);
                                        
                                        // 2. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Ø®Ø§Øµ Ø¨Ù†ÙˆØ¹ Gmail)
                                        if (type === 'gmail' && (userText.includes('Ø­Ø¬Ø²') || userText.includes('booking') || userText.includes('Ø§Ø­Ø¬Ø²'))) {
                                            // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø«Ø±ÙŠØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø¹Ø±Ø¶ toast
                                            postMessage({ 
                                                action: 'booking', 
                                                targetEmail: targetEmail,
                                                botId: botId
                                            });
                                            // Ø±Ø¯ ØªØ£ÙƒÙŠØ¯ Ø³Ø±ÙŠØ¹ Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
                                            await fetch(\`https://api.telegram.org/bot\${token}/sendMessage\`, {
                                                method: 'POST',
                                                headers: {'Content-Type': 'application/json'},
                                                body: JSON.stringify({ chat_id: chatId, text: "ğŸ“§ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² ÙˆØªØ­ÙˆÙŠÙ„Ù‡ Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¥Ù„Ù‰ aliatb27@gmail.com." })
                                            });
                                            continue; // Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
                                        }

                                        // 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (AI) Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø£Ø®Ø±Ù‰
                                        try {
                                            const aiRes = await fetch(API_URL, {
                                                method: 'POST',
                                                headers: {'Content-Type': 'application/json'},
                                                body: JSON.stringify({
                                                    messages: [
                                                        {role: 'system', content: context},
                                                        {role: 'user', content: userText}
                                                    ],
                                                    model: 'openai', // ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù‡Ù†Ø§
                                                    seed: Math.floor(Math.random() * 1000) // Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
                                                })
                                            });
                                            if (!aiRes.ok) {
                                                throw new Error(\`AI API error: \${aiRes.status} \${aiRes.statusText}\`);
                                            }
                                            const aiText = await aiRes.text();
                                            console.log(\`[Worker ${botId}] AI response: \${aiText}\`);
                                            
                                            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¹Ø¨Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
                                            await fetch(\`https://api.telegram.org/bot\${token}/sendMessage\`, {
                                                method: 'POST',
                                                headers: {'Content-Type': 'application/json'},
                                                body: JSON.stringify({ chat_id: chatId, text: aiText })
                                            });

                                        } catch(aiErr) { 
                                            console.error(\`[Worker ${botId}] AI processing error: \`, aiErr); 
                                            // Ø±Ø¯ Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                                            await fetch(\`https://api.telegram.org/bot\${token}/sendMessage\`, {
                                                method: 'POST',
                                                headers: {'Content-Type': 'application/json'},
                                                body: JSON.stringify({ chat_id: chatId, text: "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ." })
                                            });
                                        }
                                    }
                                }
                                // Ø¨Ø¹Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§ØªØŒ Ø£Ø±Ø³Ù„ Ø¢Ø®Ø± offset Ù„Ù„Ø«Ø±ÙŠØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ø­ÙØ¸Ù‡
                                postMessage({ action: 'updateOffset', offset: offset, botId: botId });
                            }
                        } catch(err) { 
                            console.error(\`[Worker ${botId}] Polling error: \`, err); 
                        } finally {
                            // Ù…Ù‡Ù…Ø§ Ø­Ø¯Ø«ØŒ Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¨Ø¹Ø¯ ÙØªØ±Ø©
                            setTimeout(poll, 1000); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© (Ø£Ùˆ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©)
                        }
                    };
                    poll(); // Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡
                };
            `;

            const blob = new Blob([workerCode], {type: 'application/javascript'});
            const worker = new Worker(URL.createObjectURL(blob));
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (ØªÙˆÙƒÙ†ØŒ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙˆØªØŒ Ø§Ù„Ø³ÙŠØ§Ù‚ØŒ Ø§Ù„Ù€ offset) Ù„Ù„Ø¹Ø§Ù…Ù„
            worker.postMessage({ 
                token: bot.config.token, 
                type: bot.type, 
                targetEmail: bot.config.targetEmail,
                context: fullContext,
                initialOffset: bot.config.lastUpdateOffset, // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù€ offset Ø§Ù„Ù…Ø­ÙÙˆØ¸
                botId: bot.id
            });

            // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø¹Ø§Ù…Ù„
            worker.onmessage = (e) => {
                if (e.data.action === 'booking') {
                    showGmailToast(e.data.targetEmail);
                } else if (e.data.action === 'updateOffset') {
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ offset ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØª Ø¨Ø§Ù„Ø«Ø±ÙŠØ¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ­ÙØ¸Ù‡Ø§
                    const currentBot = bots.find(b => b.id === e.data.botId);
                    if (currentBot) {
                        currentBot.config.lastUpdateOffset = e.data.offset;
                        saveToLocal(); // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙˆØ±Ø§Ù‹
                    }
                }
            };

            // ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ù†Ø´Ø·
            activeWorkers[bot.id] = worker;
            console.log(`Worker for bot ${bot.name} (ID: ${bot.id}) started.`);
        }

        function stopWorker(id) {
            if (activeWorkers[id]) {
                activeWorkers[id].terminate(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø§Ù…Ù„
                delete activeWorkers[id]; // Ø¥Ø²Ø§Ù„ØªÙ‡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                console.log(`Worker for bot ID ${id} stopped.`);
            }
        }

        // --- Ø§Ù„Ø¹Ø±Ø¶ (Rendering) Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨ÙˆØªØ§Øª ---
        function renderGrid() {
            const grid = document.getElementById('botsGrid');
            grid.innerHTML = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ø´Ø¨ÙƒØ© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡

            bots.forEach(bot => {
                let icon = '', typeLabel = '';
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ø§Ø³Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙˆØª
                if (bot.type === 'telegram') { icon = '<i class="fa-brands fa-telegram" style="color:#229ED9"></i>'; typeLabel='Ø¨ÙˆØª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…'; }
                else if (bot.type === 'gmail') { icon = '<i class="fa-solid fa-envelope" style="color:#EA4335"></i>'; typeLabel='Ø¨ÙˆØª Ø­Ø¬ÙˆØ²Ø§Øª (Gmail)'; }
                else if (bot.type === 'whatsapp') { icon = '<i class="fa-brands fa-whatsapp" style="color:#25D366"></i>'; typeLabel='Ø¨ÙˆØª ÙˆØ§ØªØ³Ø§Ø¨'; }
                else { icon = '<i class="fa-solid fa-user-shield" style="color:#A855F7"></i>'; typeLabel='Ø¨ÙˆØª Ø±Ù‚Ù… Ø´Ø®ØµÙŠ'; }

                const hasExcel = bot.training.excelData && bot.training.excelData.length > 5;
                const isTrained = bot.training.systemPrompt && bot.training.systemPrompt.length > 10;

                const card = document.createElement('div');
                card.className = `card ${bot.active ? 'active' : ''}`; // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¨ÙˆØªØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©

                // Ø¨Ù†Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨ÙˆØª
                card.innerHTML = `
                    <div class="card-header">
                        <div class="bot-icon">${icon}</div>
                        <label class="switch">
                            <input type="checkbox" ${bot.active ? 'checked' : ''} onchange="toggleBot(${bot.id})">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <h3 style="margin-bottom:5px;">${bot.name}</h3>
                    <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:15px;">${typeLabel}</p>
                    
                    <div class="tags">
                        ${hasExcel ? '<span class="tag excel"><i class="fa-solid fa-table"></i> Ù…Ø±ØªØ¨Ø· Ø¨Ù€ Excel</span>' : ''}
                        ${isTrained ? '<span class="tag"><i class="fa-solid fa-brain"></i> Ù…Ø¯Ø±Ø¨</span>' : '<span class="tag">ØºÙŠØ± Ù…Ø¯Ø±Ø¨</span>'}
                    </div>

                    <div class="controls">
                        <button class="btn-icon train" onclick="openTrainModal(${bot.id})" title="ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¨ÙˆØª ÙˆØªØºØ°ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">
                            <i class="fa-solid fa-graduation-cap"></i> ØªØ¯Ø±ÙŠØ¨
                        </button>
                        <button class="btn-icon delete" onclick="deleteBot(${bot.id})" title="Ø­Ø°Ù Ø§Ù„Ø¨ÙˆØª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ø§ÙƒÙ‰ Ù„ÙˆØµÙˆÙ„ Ø­Ø¬Ø² Gmail
        function showGmailToast(email) {
            const t = document.getElementById('gmailToast');
            document.getElementById('targetEmailDisplay').innerText = email;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 5000); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
        }

        // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØªØ§Øª Ø¥Ù„Ù‰ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù…ØªØµÙØ­
        function saveToLocal() { localStorage.setItem('bochat_pro_db', JSON.stringify(bots)); }
    </script>
</body>
</html>
